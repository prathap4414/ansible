events {}

http {

    {% if ansible_os_family == "Debian" %}

    upstream backend_servers {
        {% for host in groups['webservers'] %}
        server {{ hostvars[host].ansible_default_ipv4.address }}:{{nginx_port}};
        {% endfor %}
    }


    server {
        listen {{nginx_port}};
        server_name {{ inventory_hostname }};

        location / {
            proxy_pass http://backend_servers;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }

    {% else %}

    server {
        listen {{nginx_port}};
        location / {
            return 403 "Unsupported OS\n";
        }
    }

    {% endif %}

}